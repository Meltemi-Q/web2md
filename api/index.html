<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DownWeb - Web to Markdown</title>
    <style>
      :root {
        --bg: #0b1220;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.12);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --accent: #7c3aed;
        --accent2: #22c55e;
        --danger: #ef4444;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: radial-gradient(1200px 800px at 10% 0%, rgba(124, 58, 237, 0.35), transparent 60%),
          radial-gradient(1000px 700px at 90% 10%, rgba(34, 197, 94, 0.25), transparent 60%),
          var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 32px 16px 64px;
      }
      h1 {
        font-size: 28px;
        margin: 0 0 8px;
        letter-spacing: 0.2px;
      }
      p {
        margin: 8px 0 0;
        color: var(--muted);
        line-height: 1.6;
      }
      .grid {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 16px;
        margin-top: 18px;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        backdrop-filter: blur(10px);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .label {
        font-size: 13px;
        color: var(--muted);
      }
      textarea,
      input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        padding: 10px 12px;
        outline: none;
      }
      textarea {
        min-height: 200px;
        resize: vertical;
        line-height: 1.5;
      }
      input[type="file"] {
        color: var(--muted);
      }
      button {
        appearance: none;
        border: 0;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, var(--accent), #2563eb);
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border);
      }
      .status {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.25);
        color: var(--muted);
        white-space: pre-wrap;
      }
      .status.ok {
        border-color: rgba(34, 197, 94, 0.5);
        color: rgba(220, 252, 231, 0.9);
      }
      .status.err {
        border-color: rgba(239, 68, 68, 0.55);
        color: rgba(254, 226, 226, 0.92);
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        font-size: 13px;
        color: var(--muted);
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
      }
      a {
        color: rgba(147, 197, 253, 0.95);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>DownWeb - Web to Markdown</h1>
      <p>
        ä¸Šä¼ åŒ…å« URL çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼Œæˆ–è€…ç›´æ¥ç²˜è´´ URL åˆ—è¡¨ï¼Œç‚¹å‡»â€œæ‰“åŒ…ä¸‹è½½â€å³å¯è·å–
        <span class="pill">Markdown + å›¾ç‰‡ + é™„ä»¶</span>ï¼ˆé»˜è®¤æ‰“åŒ…ä¸º <span class="pill">tar.gz</span>ï¼‰ã€‚
      </p>

      <div class="grid">
        <div class="card">
          <div class="row">
            <div class="label">URL æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</div>
            <input id="file" type="file" accept=".txt,.md,text/plain" />
          </div>
          <div class="hint">æ”¯æŒ # å¼€å¤´æ³¨é‡Šè¡Œï¼›ç©ºè¡Œä¼šè¢«å¿½ç•¥ã€‚</div>

          <div style="height: 12px"></div>
          <div class="label">æˆ–ç²˜è´´ URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</div>
          <textarea id="urls" placeholder="https://example.com/a&#10;https://example.com/b"></textarea>

          <div style="height: 12px"></div>
          <div class="label">å¯¼å‡ºæ ¼å¼</div>
          <div class="row">
            <label class="pill"><input type="radio" name="format" value="markdown" checked /> Markdown + æ‰“åŒ…</label>
            <label class="pill"><input type="radio" name="format" value="pdf" /> PDFï¼ˆä»…å•ä¸ª URLï¼‰</label>
          </div>

          <div style="height: 12px"></div>
          <div class="row" id="mdOptions">
            <label class="pill"><input id="optImages" type="checkbox" checked /> ä¸‹è½½å›¾ç‰‡</label>
            <label class="pill"><input id="optFiles" type="checkbox" checked /> ä¸‹è½½é™„ä»¶</label>
          </div>

          <div style="height: 14px"></div>
          <div class="row">
            <button id="run">æ‰“åŒ…ä¸‹è½½</button>
            <button id="fillDemo" class="secondary" type="button">å¡«å……ç¤ºä¾‹</button>
          </div>

          <div id="status" class="status">å‡†å¤‡å°±ç»ªã€‚</div>
        </div>

        <div class="card">
          <div class="label">è¯´æ˜</div>
          <p style="margin-top: 10px">
            <strong>Markdown æ¨¡å¼ï¼š</strong><br />
            1) URL åˆ—è¡¨å‘é€åˆ° <code>/api/package</code>ï¼ŒæœåŠ¡ç«¯æŠ“å–ç½‘é¡µæ­£æ–‡å¹¶è½¬æ¢ä¸º Markdown<br />
            2) å›¾ç‰‡ä¸é™„ä»¶ä¼šè¢«ä¸‹è½½ï¼Œæ‰“åŒ…ä¸º <code>tar.gz</code><br /><br />
            <strong>PDF æ¨¡å¼ï¼š</strong><br />
            1) ä»…æ”¯æŒå•ä¸ª URLï¼Œå‘é€åˆ° <code>/api/pdf</code><br />
            2) æœåŠ¡ç«¯æŠ“å–å†…å®¹åæ¸²æŸ“ä¸º PDF æ–‡ä»¶<br /><br />
            <strong>é£ä¹¦æ–‡æ¡£å¯¼å‡ºï¼š</strong><br />
            é£ä¹¦æ–‡æ¡£éœ€è¦ç™»å½•æ€ï¼Œè¯·ä½¿ç”¨ Bookmarklet æ–¹æ¡ˆï¼ˆè§ä¸‹æ–¹å¡ç‰‡ï¼‰
          </p>
          <p style="margin-top: 12px">
            APIï¼š<a href="/api/extract?url=https://example.com" target="_blank" rel="noreferrer">/api/extract</a> /
            <a href="/api/batch" target="_blank" rel="noreferrer">/api/batch</a> /
            <a href="/api/package" target="_blank" rel="noreferrer">/api/package</a> /
            <a href="/api/pdf" target="_blank" rel="noreferrer">/api/pdf</a>
          </p>
        </div>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <div class="label">é£ä¹¦æ–‡æ¡£å¯¼å‡º</div>
        <p style="margin-top: 10px">
          ç”±äºé£ä¹¦æ–‡æ¡£éœ€è¦ç™»å½•æƒé™ï¼Œæ— æ³•é€šè¿‡"è¾“å…¥ç½‘å€"çš„æ–¹å¼å¯¼å‡ºã€‚<br />
          æ¨èä½¿ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š
        </p>

        <p style="margin-top: 12px"><strong>æ–¹æ¡ˆä¸€ï¼šæµè§ˆå™¨æ‰©å±•ï¼ˆæ¨èï¼‰</strong></p>
        <ol style="margin-top: 8px; padding-left: 20px; color: var(--muted)">
          <li>å®‰è£… <a href="https://github.com/whale4113/cloud-document-converter" target="_blank" rel="noreferrer" style="color: var(--accent2);">Cloud Document Converter</a> æ‰©å±•</li>
          <li>æ”¯æŒ Chrome / Edge / Firefox</li>
          <li>åŠŸèƒ½å®Œæ•´ï¼šæ–‡æ¡£ã€å›¾ç‰‡ã€é™„ä»¶ã€ç™½æ¿ã€æµç¨‹å›¾ç­‰</li>
        </ol>

        <p style="margin-top: 12px"><strong>æ–¹æ¡ˆäºŒï¼šBookmarkletï¼ˆå¿«æ·å·¥å…·ï¼‰</strong></p>
        <ol style="margin-top: 8px; padding-left: 20px; color: var(--muted)">
          <li>å°†ä»¥ä¸‹é“¾æ¥æ‹–æ‹½åˆ°æµè§ˆå™¨ä¹¦ç­¾æ ï¼š
            <a href="javascript:(function(){var s=document.createElement('script');s.src='/lark-converter.js';document.body.appendChild(s);})();"
               style="display: inline-block; padding: 4px 8px; margin: 4px 0; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 6px; color: var(--accent2);">
              ğŸ“¥ å¯¼å‡ºé£ä¹¦æ–‡æ¡£
            </a>
          </li>
          <li>æ‰“å¼€é£ä¹¦æ–‡æ¡£é¡µé¢ â†’ ç‚¹å‡»ä¹¦ç­¾</li>
          <li>ä¸‹è½½ Markdownï¼ˆåŸºç¡€åŠŸèƒ½ï¼Œæš‚ä¸æ”¯æŒå›¾ç‰‡ï¼‰</li>
        </ol>
        <p style="margin-top: 12px; font-size: 13px; color: var(--muted)">
          æ³¨ï¼šä¸¤ç§æ–¹æ¡ˆéƒ½åˆ©ç”¨ä½ çš„æµè§ˆå™¨ç™»å½•çŠ¶æ€ï¼Œæ•°æ®åœ¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚
        </p>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const statusEl = $('status');
      const runBtn = $('run');
      const demoBtn = $('fillDemo');
      const mdOptionsEl = $('mdOptions');

      function setStatus(text, kind) {
        statusEl.textContent = text;
        statusEl.classList.remove('ok', 'err');
        if (kind) statusEl.classList.add(kind);
      }

      function parseUrls(text) {
        return (text || '')
          .split(/\r?\n/g)
          .map((l) => l.trim())
          .filter((l) => l && !l.startsWith('#'));
      }

      async function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result || ''));
          reader.onerror = () => reject(reader.error || new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
          reader.readAsText(file);
        });
      }

      // ç›‘å¬æ ¼å¼é€‰æ‹©å˜åŒ–
      document.querySelectorAll('input[name="format"]').forEach((radio) => {
        radio.addEventListener('change', (e) => {
          const isPdf = e.target.value === 'pdf';
          mdOptionsEl.style.display = isPdf ? 'none' : 'flex';
          runBtn.textContent = isPdf ? 'å¯¼å‡º PDF' : 'æ‰“åŒ…ä¸‹è½½';
        });
      });

      demoBtn.addEventListener('click', () => {
        $('urls').value = [
          'https://news.ycombinator.com/',
          'https://github.com/',
          '# ä¹Ÿå¯ä»¥æ”¾æ–‡ç« é“¾æ¥',
        ].join('\n');
      });

      runBtn.addEventListener('click', async () => {
        runBtn.disabled = true;
        const format = document.querySelector('input[name="format"]:checked').value;

        try {
          if (format === 'pdf') {
            await handlePdfExport();
          } else {
            await handleMarkdownExport();
          }
        } catch (e) {
          setStatus(`å¤±è´¥ï¼š${e && e.message ? e.message : String(e)}`, 'err');
        } finally {
          runBtn.disabled = false;
        }
      });

      async function handlePdfExport() {
        setStatus('æ­£åœ¨è¯»å– URL...', null);

        let urls = [];
        const file = $('file').files && $('file').files[0];
        if (file) {
          const text = await readFile(file);
          urls = parseUrls(text);
        } else {
          urls = parseUrls($('urls').value);
        }

        if (!urls.length) {
          setStatus('æ²¡æœ‰æœ‰æ•ˆ URLã€‚è¯·è¾“å…¥æˆ–ç²˜è´´ URLã€‚', 'err');
          return;
        }

        if (urls.length > 1) {
          setStatus('PDF æ¨¡å¼ä»…æ”¯æŒå•ä¸ª URLã€‚è¯·ä½¿ç”¨ Markdown æ¨¡å¼å¤„ç†å¤šä¸ª URLã€‚', 'err');
          return;
        }

        setStatus(`æ­£åœ¨ç”Ÿæˆ PDFï¼š${urls[0]}...\nï¼ˆæç¤ºï¼šPDF ç”Ÿæˆå¯èƒ½éœ€è¦ 10-30 ç§’ï¼‰`, null);

        const resp = await fetch('/api/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: urls[0] }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `document_${Date.now()}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus('PDF ç”Ÿæˆå®Œæˆï¼šå·²å¼€å§‹ä¸‹è½½ã€‚', 'ok');
      }

      async function handleMarkdownExport() {
        setStatus('æ­£åœ¨è¯»å– URL åˆ—è¡¨...', null);

        let urls = [];
        const file = $('file').files && $('file').files[0];
        if (file) {
          const text = await readFile(file);
          urls = parseUrls(text);
        } else {
          urls = parseUrls($('urls').value);
        }

        if (!urls.length) {
          setStatus('æ²¡æœ‰æœ‰æ•ˆ URLã€‚è¯·ä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´ URL åˆ—è¡¨ã€‚', 'err');
          return;
        }

        setStatus(`å¼€å§‹æ‰“åŒ…ï¼š${urls.length} ä¸ª URL...\nï¼ˆæç¤ºï¼šå¤§æ‰¹é‡å»ºè®®ç”¨ CLIï¼Œæœ¬é¡µé¢/Serverless æœ‰æ—¶é™ï¼‰`, null);

        const resp = await fetch('/api/package', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            urls,
            downloadImages: $('optImages').checked,
            downloadFiles: $('optFiles').checked,
          }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `downweb_${Date.now()}.tar.gz`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus('æ‰“åŒ…å®Œæˆï¼šå·²å¼€å§‹ä¸‹è½½ã€‚\nè§£å‹åæŸ¥çœ‹æ¯ç¯‡æ–‡ç« æ–‡ä»¶å¤¹ä¸­çš„ index.mdã€‚', 'ok');
      }
    </script>
  </body>
</html>

